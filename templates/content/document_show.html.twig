{% extends 'base.html.twig' %}

{% block title %}{{ document.title }} - EduLearn{% endblock %}

{% block body %}
<div class="container py-5">
    <a href="{{ path('app_dashboard') }}" class="btn btn-outline-secondary mb-4 rounded-pill">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left me-2" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
        </svg>
        Retour au tableau de bord
    </a>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0 overflow-hidden rounded-4">
                <div class="card-body p-5">
                    <div class="d-flex justify-content-between align-items-start mb-5">
                        <div>
                            <div class="d-flex align-items-center mb-3">
                                <span class="badge bg-primary me-3 px-3 py-2 rounded-pill">{{ document.filename|split('.')|last|upper }}</span>
                                <span class="text-muted">AjoutÃ© le {{ document.createdAt|date('d/m/Y') }}</span>
                            </div>
                            <h1 class="fw-bold mb-2">{{ document.title }}</h1>
                        </div>
                        <div class="d-flex gap-2 flex-wrap justify-content-end action-bar">
                             <a href="{{ asset('uploads/documents/' ~ document.filename) }}" target="_blank" class="btn btn-light text-primary rounded-circle p-2 d-flex align-items-center justify-content-center border shadow-sm" style="width: 42px; height: 42px;" data-bs-toggle="tooltip" data-bs-placement="top" title="TÃ©lÃ©charger le document">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                                </svg>
                            </a>
                            
                             {% if document.qcm %}
                                <a href="{{ path('app_document_take_qcm', {'id': document.id}) }}" class="btn btn-light text-success rounded-circle p-2 d-flex align-items-center justify-content-center border shadow-sm" style="width: 42px; height: 42px;" data-bs-toggle="tooltip" data-bs-placement="top" title="Passer le QCM">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-play-circle-fill" viewBox="0 0 16 16">
                                        <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"/>
                                    </svg>
                                </a>
                                <button type="button" class="btn btn-light text-warning rounded-circle p-2 d-flex align-items-center justify-content-center border shadow-sm" style="width: 42px; height: 42px;" data-bs-toggle="modal" data-bs-target="#generateQcmModal" data-force="1" data-bs-toggle="tooltip" data-bs-placement="top" title="RÃ©gÃ©nÃ©rer le QCM">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                                        <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/>
                                        <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"/>
                                    </svg>
                                </button>
                             {% else %}
                                 <button type="button" class="btn btn-primary rounded-circle p-2 d-flex align-items-center justify-content-center shadow-sm" style="width: 42px; height: 42px;" data-bs-toggle="modal" data-bs-target="#generateQcmModal" data-force="0" data-bs-toggle="tooltip" data-bs-placement="top" title="GÃ©nÃ©rer un QCM IA">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16">
                                        <path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828l.645-1.937zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.734 1.734 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.734 1.734 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.734 1.734 0 0 0 3.407 2.31l.387-1.162zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L10.863.1z"/>
                                    </svg>
                                </button>
                             {% endif %}
                            
                            <form method="post" action="{{ path('app_document_delete', {'id': document.id}) }}" onsubmit="return confirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce document ? Cette action est irrÃ©versible.');" class="d-inline">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ document.id) }}">
                                <button class="btn btn-light text-danger rounded-circle p-2 d-flex align-items-center justify-content-center border shadow-sm" style="width: 42px; height: 42px;" data-bs-toggle="tooltip" data-bs-placement="top" title="Supprimer le document">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                                        <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>
                                    </svg>
                                </button>
                            </form>
                        </div>
                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                                    return new bootstrap.Tooltip(tooltipTriggerEl)
                                })
                            });
                        </script>
                    </div>
                    
                    <h5 class="fw-bold mb-3">Description</h5>
                    <p class="text-muted lead mb-5">{{ document.description|nl2br }}</p>

                    <!-- Document Preview (Iframe) -->
                    <div class="ratio ratio-16x9 border rounded-4 bg-light mb-5">
                        <iframe src="{{ asset('uploads/documents/' ~ document.filename) }}" allowfullscreen></iframe>
                    </div>

                    {% if document.qcm %}
                        <hr class="my-5">
                        
                        <div class="d-flex align-items-center mb-4">
                            <span class="fs-2 me-3">ðŸ§ </span>
                            <h3 class="fw-bold m-0">QCM GÃ©nÃ©rÃ©</h3>
                        </div>

                        {% for q in document.qcm.content %}
                            <div class="card shadow-sm border-0 rounded-4 mb-4 bg-light">
                                <div class="card-body p-4">
                                    <h5 class="card-title fw-bold mb-3">{{ loop.index }}. {{ q.question }}</h5>
                                    <ul class="list-group list-group-flush rounded-3 mb-3">
                                        {% for option in q.options %}
                                            <li class="list-group-item bg-white border-0 mb-1 rounded-3">
                                                {{ option }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                    <div class="accordion" id="accordionAnswer{{ loop.index }}">
                                        <div class="accordion-item border-0 bg-transparent">
                                            <h2 class="accordion-header" id="heading{{ loop.index }}">
                                                <button class="accordion-button collapsed rounded-pill bg-white text-success shadow-none fw-bold px-4" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
                                                    ðŸ‘€ Voir la rÃ©ponse
                                                </button>
                                            </h2>
                                            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#accordionAnswer{{ loop.index }}">
                                                <div class="accordion-body text-success pt-2">
                                                    <strong>RÃ©ponse(s) correcte(s) :</strong> 
                                                    {% if q.answer is iterable %}
                                                        {{ q.answer|join(', ') }}
                                                    {% else %}
                                                        {{ q.answer }}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate QCM Modal -->
<div class="modal fade" id="generateQcmModal" tabindex="-1" aria-labelledby="generateQcmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 border-0 shadow-lg">
      <form action="{{ path('app_document_generate_qcm', {'id': document.id}) }}" method="GET">
          <div class="modal-header border-0 pb-0">
            <h1 class="modal-title fs-5 fw-bold" id="generateQcmModalLabel">âœ¨ Configuration du QCM</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <input type="hidden" name="force" id="qcmForceInput" value="0">
            
            <div class="mb-4">
                <label for="nbQuestions" class="form-label fw-semibold">Nombre de questions</label>
                <div class="d-flex align-items-center gap-2">
                     <input type="range" class="form-range" min="1" max="10" step="1" id="nbQuestionsRange" value="5" name="nb_questions" oninput="document.getElementById('nbQuestionsValue').textContent = this.value">
                     <span class="badge bg-primary rounded-pill px-3 py-2 fs-6" id="nbQuestionsValue">5</span>
                </div>
            </div>

            <div class="form-check form-switch p-0 d-flex justify-content-between align-items-center bg-light rounded-3 p-3 position-relative">
                <label class="form-check-label fw-semibold stretched-link" for="multipleCorrect">
                    Autoriser plusieurs bonnes rÃ©ponses
                </label>
                <input class="form-check-input m-0" type="checkbox" role="switch" id="multipleCorrect" name="multiple_correct" value="1">
            </div>
          </div>
          <div class="modal-footer border-0 pt-0">
            <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Annuler</button>
            <button type="submit" class="btn btn-primary rounded-pill px-4">ðŸš€ GÃ©nÃ©rer</button>
          </div>
      </form>
    </div>
  </div>
</div>

<script>
    const generateQcmModal = document.getElementById('generateQcmModal');
    generateQcmModal.addEventListener('show.bs.modal', event => {
        let button = event.relatedTarget;
        
        // Handle trigger via JS (not button click)
        if (!button) {
            // Find the visible trigger button on the page to default to
            button = document.querySelector('[data-bs-target="#generateQcmModal"]');
        }

        const force = button ? button.getAttribute('data-force') : '0';
        const modalInput = generateQcmModal.querySelector('#qcmForceInput');
        modalInput.value = force;
    });

    // Auto-open if action=generate is in URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('action') === 'generate') {
        const triggerBtn = document.querySelector('[data-bs-target="#generateQcmModal"]');
        if (triggerBtn) {
            triggerBtn.click();
        }
    }
</script>
            </div>
        </div>
    </div>
</div>
{% endblock %}
