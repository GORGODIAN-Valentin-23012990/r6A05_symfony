{% extends 'base.html.twig' %}

{% block title %}Tableau de bord - EduLearn{% endblock %}

{% block body %}
    <div class="container py-5">
        <header class="mb-5">
            <div>
                <h1 class="fw-bold mb-1">Bonjour, {{ app.user.firstname|default(app.user.email|split('@')[0])|capitalize }} ! üëã</h1>
                <p class="text-muted mb-0">G√©rez vos cours et cr√©ez de nouveaux contenus p√©dagogiques.</p>
            </div>
        </header>

        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold m-0">Vid√©os Recommand√©es</h3>
                <button type="button" class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#uploadVideoModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-upload-fill me-2" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 0a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 4.095 0 5.555 0 7.318 0 9.366 1.708 11 3.781 11H7.5V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11h4.188C14.502 11 16 9.57 16 7.773c0-1.636-1.242-2.969-2.834-3.194C12.923 1.999 10.69 0 8 0zm-.5 14.5V11h1v3.5a.5.5 0 0 1-1 0z"/>
                    </svg>
                    Importer une vid√©o
                </button>
            </div>
            
            <div class="video-carousel-container position-relative group">
                <!-- Prev Button -->
                <button class="carousel-btn btn-prev d-none d-md-flex" onclick="document.getElementById('videoCarousel').scrollBy({left: -340, behavior: 'smooth'})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                    </svg>
                </button>

                <div class="video-carousel" id="videoCarousel">
                    {% if videos is defined and videos|length > 0 %}
                        {% for video in videos %}
                            <div class="video-card card h-100">
                                <a href="{{ path('app_video_show', {'id': video.id}) }}" class="text-decoration-none text-dark">
                                    <div class="card-img-top bg-dark position-relative d-flex align-items-center justify-content-center" style="height: 180px;">
                                        {% if video.filename %}
                                            <video src="{{ asset('uploads/videos/' ~ video.filename) }}" class="w-100 h-100 object-fit-cover" preload="metadata"></video>
                                        {% else %}
                                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="white" class="bi bi-play-circle-fill opacity-75" viewBox="0 0 16 16">
                                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"/>
                                            </svg>
                                        {% endif %}
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title fw-bold text-truncate" title="{{ video.title }}">{{ video.title }}</h5>
                                        <p class="card-text text-muted small text-truncate">{{ video.description }}</p>
                                    </div>
                                </a>
                                <div class="card-footer bg-white border-top-0 pt-0">
                                    <div class="d-grid gap-2">
                                        <a href="{{ path('app_video_show', {'id': video.id, 'action': 'generate'}) }}" class="btn btn-outline-primary btn-sm rounded-pill">‚ú® G√©n√©rer QCM</a>
                                        {% if video.qcm %}
                                            <a href="{{ path('app_video_take_qcm', {'id': video.id}) }}" class="btn btn-primary btn-sm rounded-pill">üìù Passer QCM</a>
                                        {% else %}
                                            <button class="btn btn-secondary btn-sm rounded-pill" disabled>üìù Passer QCM</button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="col-12 text-center py-5">
                            <p class="text-muted">Aucune vid√©o disponible pour le moment.</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Next Button -->
                <button class="carousel-btn btn-next d-none d-md-flex" onclick="document.getElementById('videoCarousel').scrollBy({left: 340, behavior: 'smooth'})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L9.293 8 4.646 3.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>

            <!-- Upload Modal -->
            <div class="modal fade" id="uploadVideoModal" tabindex="-1" aria-labelledby="uploadVideoModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold" id="uploadVideoModalLabel">Importer une vid√©o</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="post" enctype="multipart/form-data">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="videoTitle" class="form-label">Titre de la vid√©o</label>
                                    <input type="text" class="form-control" id="videoTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="videoDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="videoDescription" name="description" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="videoFile" class="form-label">Fichier vid√©o</label>
                                    <input type="file" class="form-control" id="videoFile" name="video_file" accept="video/*" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Annuler</button>
                                <button type="submit" class="btn btn-primary rounded-pill">Importer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold m-0">Documents de Cours</h3>
                <button type="button" class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-upload-fill me-2" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 0a5.53 5.53 0 0 0-3.594 1.342c-.766.66-1.321 1.52-1.464 2.383C1.266 4.095 0 5.555 0 7.318 0 9.366 1.708 11 3.781 11H7.5V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11h4.188C14.502 11 16 9.57 16 7.773c0-1.636-1.242-2.969-2.834-3.194C12.923 1.999 10.69 0 8 0zm-.5 14.5V11h1v3.5a.5.5 0 0 1-1 0z"/>
                    </svg>
                    Importer un document
                </button>
            </div>
            
            <div class="video-carousel-container position-relative group">
                <!-- Prev Button -->
                <button class="carousel-btn btn-prev d-none d-md-flex" onclick="document.getElementById('documentCarousel').scrollBy({left: -340, behavior: 'smooth'})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chevron-left" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                    </svg>
                </button>

                <div class="video-carousel" id="documentCarousel">
                    {% if documents is defined and documents|length > 0 %}
                        {% for document in documents %}
                            <div class="video-card card h-100">
                                <a href="{{ path('app_document_show', {'id': document.id}) }}" class="text-decoration-none text-dark">
                                    <div class="card-img-top bg-primary position-relative d-flex align-items-center justify-content-center" style="height: 180px;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="white" class="bi bi-file-earmark-text opacity-75" viewBox="0 0 16 16">
                                            <path d="M5.5 7a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5zM5 9.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5z"/>
                                            <path d="M9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.5L9.5 0zm0 1v2A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                                        </svg>
                                        <span class="badge bg-light text-dark position-absolute bottom-0 end-0 m-2">{{ document.filename|split('.')|last|upper }}</span>
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title fw-bold text-truncate" title="{{ document.title }}">{{ document.title }}</h5>
                                        <p class="card-text text-muted small text-truncate">{{ document.description }}</p>
                                    </div>
                                </a>
                                <div class="card-footer bg-white border-top-0 pt-0">
                                    <div class="d-grid gap-2">
                                        <a href="{{ path('app_document_show', {'id': document.id, 'action': 'generate'}) }}" class="btn btn-outline-primary btn-sm rounded-pill">‚ú® G√©n√©rer QCM</a>
                                        <a href="{{ path('app_document_take_qcm', {'id': document.id}) }}" class="btn btn-primary btn-sm rounded-pill">üìù Passer QCM</a>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                       <div class="col-12 text-center py-5">
                            <p class="text-muted">Aucun document disponible pour le moment.</p>
                        </div>
                    {% endif %}
                </div>

                <!-- Next Button -->
                <button class="carousel-btn btn-next d-none d-md-flex" onclick="document.getElementById('documentCarousel').scrollBy({left: 340, behavior: 'smooth'})">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L9.293 8 4.646 3.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            
            <!-- Upload Document Modal -->
            <div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fw-bold" id="uploadDocumentModalLabel">Importer un document</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form method="post" enctype="multipart/form-data">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="documentTitle" class="form-label">Titre du document</label>
                                    <input type="text" class="form-control" id="documentTitle" name="title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="documentDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="documentDescription" name="description" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="documentFile" class="form-label">Fichier (PDF, DOCX...)</label>
                                    <input type="file" class="form-control" id="documentFile" name="document_file" required>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Annuler</button>
                                <button type="submit" class="btn btn-primary rounded-pill">Importer</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>
        <section class="mb-5">
            <h3 class="fw-bold mb-4">R√©sultats des QCM</h3>
            
            <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="border-0 py-3 ps-4">√âtudiant</th>
                                <th class="border-0 py-3">Titre du QCM</th>
                                <th class="border-0 py-3">Date</th>
                                <th class="border-0 py-3">Score</th>
                                <th class="border-0 py-3">Note</th>
                                <th class="border-0 py-3 pe-4 text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if results is defined and results|length > 0 %}
                                {% for result in results %}
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; font-weight: 600;">
                                                    {{ result.user.firstname|first|default(result.user.email|first)|upper }}
                                                </div>
                                                <div>
                                                    <div class="fw-bold">{{ result.user.firstname }}</div>
                                                    <div class="text-muted small">{{ result.user.email }}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="fw-semibold">{{ result.qcm.document.title }}</td>
                                        <td>{{ result.createdAt|date('d/m/y') }}</td>
                                        <td><span class="fw-bold">{{ result.score }}</span> / {{ result.maxScore }}</td>
                                        <td>
                                            {% set ratio = result.score / result.maxScore %}
                                            {% if ratio >= 0.8 %}
                                                <span class="badge bg-success rounded-pill px-3">Excellent</span>
                                            {% elseif ratio >= 0.5 %}
                                                <span class="badge bg-info rounded-pill px-3">Bien</span>
                                            {% else %}
                                                <span class="badge bg-warning rounded-pill px-3">Moyen</span>
                                            {% endif %}
                                        </td>
                                        <td class="pe-4 text-end">
                                            <button class="btn btn-sm btn-outline-primary rounded-pill">Voir les d√©tails</button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-5 text-muted">
                                        Aucun r√©sultat pour le moment.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>
{% endblock %}
