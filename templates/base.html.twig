<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>{% block title %}Welcome!{% endblock %}</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>⚫️</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">
        {% block stylesheets %}
        {% endblock %}

        {% block javascripts %}
            {% block importmap %}{{ importmap('app') }}{% endblock %}
        {% endblock %}
    </head>
    <body class="bg-light">
        {% if not hide_navbar|default(false) %}
        <nav class="navbar navbar-expand-lg sticky-top modern-navbar">
            <div class="container">
                <a class="navbar-brand d-flex align-items-center fw-bold text-primary" href="{{ path('app_home') }}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-mortarboard-fill me-2" viewBox="0 0 16 16">
                        <path d="M8.211 2.047a.5.5 0 0 0-.422 0l-7.5 3.5a.5.5 0 0 0 .025.917l7.5 3a.5.5 0 0 0 .372 0L14 7.14V13a1 1 0 0 0-1 1v2h3v-2a1 1 0 0 0-1-1V6.739l.686-.275a.5.5 0 0 0 .025-.917l-7.5-3.5Z"/>
                        <path d="M4.176 9.032a.5.5 0 0 0-.656.327l-.5 1.7a.5.5 0 0 0 .294.605l4.5 1.8a.5.5 0 0 0 .372 0l4.5-1.8a.5.5 0 0 0 .294-.605l-.5-1.7a.5.5 0 0 0-.656-.327L8 10.466 4.176 9.032Z"/>
                    </svg>
                    EduLearn
                </a>
                
                <div class="ms-auto">
                    {% if app.user %}
                        <a href="{{ path('app_logout') }}" class="btn btn-outline-danger rounded-pill px-4">Déconnexion</a>
                    {% else %}
                        <a href="{{ path('app_login') }}" class="btn btn-primary rounded-pill px-4 shadow-sm">Connexion</a>
                    {% endif %}
                </div>
            </div>
        </nav>
        {% endif %}

        {% block body %}{% endblock %}

        <!-- Modern Full-screen Loader -->
        <div id="ai-loader" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex flex-column align-items-center justify-content-center" style="z-index: 9999; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);">
            <div class="position-relative mb-4">
                <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="position-absolute top-50 start-50 translate-middle">
                    <span class="fs-4">✨</span>
                </div>
            </div>
            <h3 class="fw-bold text-primary mb-2" id="loader-title">Analyse en cours...</h3>
            <p class="text-muted" id="loader-subtitle">L'IA étudie le contenu pour générer le QCM.</p>
            
            <div class="progress w-25 mt-3 rounded-pill" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" id="loader-progress" role="progressbar" style="width: 100%"></div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const loader = document.getElementById('ai-loader');
                const title = document.getElementById('loader-title');
                const sub = document.getElementById('loader-subtitle');
                
                // Messages to cycle through
                const messages = [
                    { t: "Extracting audio...", s: "Extraction de la piste sonore de la vidéo." },
                    { t: "Transcribing...", s: "Conversion de l'audio en texte avec Mistral AI." },
                    { t: "Analyzing...", s: "Compréhension des concepts clés et du contexte." },
                    { t: "Generating Questions...", s: "Création des questions pertinentes et des distracteurs." },
                    { t: "Finalizing...", s: "Mise en forme du QCM final." }
                ];

                window.showAiLoader = function() {
                    loader.classList.remove('d-none');
                    let step = 0;
                    
                    // Show first message immediately
                    if (messages.length > 0) {
                        title.textContent = messages[0].t;
                        sub.textContent = messages[0].s;
                    }

                    // Cycle messages every 4 seconds, stopping at the last one
                    const interval = setInterval(() => {
                        step++;
                        if (step >= messages.length) {
                            clearInterval(interval);
                            return;
                        }
                        const msg = messages[step];
                        title.textContent = msg.t;
                        sub.textContent = msg.s;
                    }, 4000);
                };

                // Attach to forms with 'data-ai-loader'
                document.querySelectorAll('form').forEach(form => {
                    form.addEventListener('submit', function() {
                        if (this.action.includes('generate-qcm')) {
                            // Try to hide modal if bootstrap is available, otherwise just rely on z-index
                            const modalEl = this.closest('.modal');
                            if (modalEl && window.bootstrap) {
                                const modal = bootstrap.Modal.getInstance(modalEl);
                                if (modal) modal.hide();
                            } else if (modalEl) {
                                // Fallback: manually hide modal backdrop and modal if bootstrap isn't global
                                // But simpler is just to let the loader cover it (z-index 9999)
                            }
                            window.showAiLoader();
                        }
                    });
                });
            });
        </script>
    </body>
</html>
